<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã´ã“ã‚¯ãƒªãƒƒãƒ— Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        body { font-family: 'Zen+Maru+Gothic', sans-serif; background-color: #fce7f3; }
        
        /* === ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ & UIãƒ‘ãƒ¼ãƒ„ === */
        .page { display: none; min-height: 100vh; flex-direction: column; opacity: 0; transition: opacity 0.3s ease; }
        .page.active { display: flex; opacity: 1; animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUpFade { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        
        .stagger-item { opacity: 0; transform: translateY(10px); }
        .page.active .stagger-item { animation: fadeInUp 0.5s ease forwards; }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        .bouncy-btn:active { transform: scale(0.95); transition: 0.1s; }
        .nav-item.active { color: #ec4899; transform: translateY(-5px); }
        
        .note-icon { transition: all 0.2s; cursor: pointer; fill: #e5e7eb; }
        .note-icon.active { fill: #ec4899; filter: drop-shadow(0 0 5px rgba(236, 72, 153, 0.5)); transform: scale(1.2); }
        .bounce-in { animation: bounceIn 0.5s; }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fdf2f8; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.6s ease-out, visibility 0.6s; }
        #splash-screen.fade-out { opacity: 0; visibility: hidden; }
        .logo-bounce { animation: logoBounce 1.5s infinite; }
        @keyframes logoBounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1) rotate(5deg); } }
    </style>
</head>
<body class="flex justify-center items-start">

    <div id="splash-screen">
        <div class="text-center logo-bounce">
            <div class="text-8xl mb-4 drop-shadow-sm">ğŸ”¥</div>
            <h1 class="text-pink-500 font-black text-4xl tracking-widest drop-shadow-sm">PicoClip</h1>
            <p class="text-gray-400 font-bold text-xs mt-2 tracking-widest">Ultimate Edition</p>
        </div>
    </div>

    <div class="w-full max-w-md bg-white min-h-screen shadow-2xl relative flex flex-col overflow-hidden">
        
        <div id="page-home" class="page active pb-24">
            <div class="p-4 border-b bg-white/90 backdrop-blur-md sticky top-0 z-10 flex justify-between items-center">
                <div class="w-8"></div>
                <div class="flex items-center gap-2">
    				<img src="picoclip_logo.png" alt="PicoClip Logo" class="w-8 h-8 rounded-lg shadow-sm">
    				<h1 class="text-pink-500 font-black text-lg tracking-wider">PicoClip</h1>
				</div>
                <button class="text-gray-400 bouncy-btn">ğŸ””</button>
            </div>

            <div class="overflow-y-auto hide-scrollbar">
                <div class="aspect-video bg-black relative mb-4 stagger-item shadow-lg transition-all duration-500" id="player-container">
                     <iframe id="main-player" class="w-full h-full" src="" title="Video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>

                <div class="px-6 pb-6">
                    <div class="stagger-item">
                        <div class="flex items-center gap-2 mb-2">
                            <span id="player-tag" class="bg-gray-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">Waiting...</span>
                            <span class="text-xs text-gray-400">Now Playing</span>
                        </div>
                        <h2 id="video-title" class="text-xl font-bold mb-4 text-gray-800 leading-snug">å‹•ç”»ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</h2>
                    </div>

                    <div class="stagger-item bg-pink-50 rounded-3xl p-5 text-center mb-6 border border-pink-100 shadow-sm">
                        <div class="flex items-center justify-center gap-4 mb-4 pb-4 border-b border-pink-100">
                            <div class="text-center">
                                <p class="text-[10px] text-gray-400 font-bold">ç¾åœ¨ã®ã‚¹ã‚³ã‚¢</p>
                                <span id="display-score" class="text-pink-500 text-4xl font-black drop-shadow-sm">â™ª--</span>
                            </div>
                            <div class="text-center border-l border-pink-100 pl-4">
                                <p class="text-[10px] text-gray-400 font-bold">ç·è©•ä¾¡æ•°</p>
                                <span id="display-votes" class="text-gray-500 text-sm font-bold">-- è©•ä¾¡</span>
                            </div>
                        </div>

                        <p class="text-xs font-bold text-gray-400 mb-3">ã‚ãªãŸã®ã€Œã´ã“ã‚“ï¼ã€åº¦ã¯ï¼Ÿ</p>
                        <div class="flex justify-center gap-2 mb-4">
                            <svg onclick="rateHome(1)" class="note-icon w-9 h-9" viewBox="0 0 24 24"></svg>
                            <svg onclick="rateHome(2)" class="note-icon w-9 h-9" viewBox="0 0 24 24"></svg>
                            <svg onclick="rateHome(3)" class="note-icon w-9 h-9" viewBox="0 0 24 24"></svg>
                            <svg onclick="rateHome(4)" class="note-icon w-9 h-9" viewBox="0 0 24 24"></svg>
                            <svg onclick="rateHome(5)" class="note-icon w-9 h-9" viewBox="0 0 24 24"></svg>
                        </div>
                        <div id="home-rating-label" class="h-6 mb-3"><span class="text-gray-300 text-xs font-bold">ã‚¿ãƒƒãƒ—ã—ã¦è©•ä¾¡</span></div>
                        <button id="home-submit-btn" disabled onclick="submitRating()" class="w-full bg-gray-100 text-gray-400 font-bold py-3 rounded-xl transition-all shadow-none bouncy-btn">è©•ä¾¡ã‚’é€ã‚‹ âœ¨</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-rank" class="page pb-24 bg-gray-50">
            <div class="p-4 bg-white sticky top-0 z-10 shadow-sm text-center">
                <h1 class="text-pink-500 font-black text-lg">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
            </div>
            <div class="p-4 overflow-y-auto hide-scrollbar">
                <div id="ranking-container" class="space-y-4">
                    <p class="text-center text-gray-400 text-xs mt-10">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...<br>ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æŠ•ç¨¿ã—ã¦ã­ï¼ï¼‰</p>
                </div>
            </div>
        </div>

        <div id="page-post" class="page pb-24 bg-white">
            <div class="p-4 border-b flex justify-between items-center">
                <button onclick="showPage('home')" class="text-gray-400 font-bold text-sm bouncy-btn">æˆ»ã‚‹</button>
                <h1 class="text-gray-800 font-bold">æ–°è¦æŠ•ç¨¿</h1>
                <div class="w-8"></div>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="stagger-item space-y-2">
                    <label class="text-xs font-bold text-gray-500">å‹•ç”»ã®URL (YouTube / TikTok)</label>
                    <input type="text" id="url-input" oninput="checkUrl()" placeholder="ã“ã“ã«URLã‚’ãƒšãƒ¼ã‚¹ãƒˆ..." class="w-full p-4 bg-gray-50 rounded-2xl text-sm focus:outline-none focus:ring-2 focus:ring-pink-300 transition-all">
                </div>

                <div id="preview-area" class="stagger-item aspect-video bg-pink-50 rounded-2xl border-2 border-dashed border-pink-200 flex flex-col items-center justify-center text-pink-300 overflow-hidden relative">
                    <div id="preview-placeholder" class="text-center">
                        <span class="text-3xl mb-2 block">ğŸ“¥</span>
                        <span class="text-xs font-bold">URLã‚’è²¼ã‚‹ã¨å‹•ç”»ãŒå‡ºã‚‹ã‚ˆ<br>(TikTokã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸å¯)</span>
                    </div>
                    <iframe id="preview-frame" class="w-full h-full hidden" src="" frameborder="0"></iframe>
                </div>
                
                <div class="stagger-item pt-2">
                    <button onclick="submitPost()" class="w-full bg-gradient-to-r from-pink-500 to-pink-400 text-white font-black text-lg py-4 rounded-2xl shadow-lg shadow-pink-200 hover:scale-[1.02] active:scale-95 transition-all bouncy-btn flex items-center justify-center gap-2">
                        <span>ğŸš€</span>
                        æŠ•ç¨¿ã™ã‚‹
                    </button>
                    <p class="text-[10px] text-gray-400 text-center mt-3">â€»æŠ•ç¨¿ã™ã‚‹ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸Šä½ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼âœ¨</p>
                </div>
            </div>
        </div>
        <div class="bg-white/95 backdrop-blur border-t border-gray-100 py-2 px-8 flex justify-between items-end sticky bottom-0 z-30 h-20 pb-6 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.03)] w-full max-w-md absolute">
            <button onclick="showPage('home')" id="nav-home" class="nav-item active flex flex-col items-center w-16 bouncy-btn"><span class="text-2xl mb-1">ğŸ </span><span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span></button>
            <button onclick="showPage('post')" id="nav-post" class="nav-item flex flex-col items-center w-16 bouncy-btn relative group">
                <div class="absolute -top-10 bg-gradient-to-tr from-pink-500 to-pink-400 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg shadow-pink-200 group-hover:scale-110 transition-transform duration-300"><span class="text-2xl font-bold pb-1">ï¼‹</span></div>
                <span class="text-[10px] font-bold mt-5 text-gray-400 group-hover:text-pink-500">æŠ•ç¨¿</span>
            </button>
            <button onclick="showPage('rank')" id="nav-rank" class="nav-item flex flex-col items-center w-16 bouncy-btn"><span class="text-2xl mb-1">ğŸ‘‘</span><span class="text-[10px] font-bold">ãƒ©ãƒ³ã‚¯</span></button>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”¥ Firebaseè¨­å®š (ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚‹ï¼)
        // ==========================================
        const firebaseConfig = {
  	        apiKey: "AIzaSyBjkR_CDNmSkelT8LZ6NKCVvLwzf3TX0S0",
  	        authDomain: "picoclip-9bda2.firebaseapp.com",
	        databaseURL: "https://picoclip-9bda2-default-rtdb.asia-southeast1.firebasedatabase.app",
  	        projectId: "picoclip-9bda2",
  	        storageBucket: "picoclip-9bda2.firebasestorage.app",
  	        messagingSenderId: "498414735492",
  	        appId: "1:498414735492:web:cd190d40ebf973fb98f2d1"
	    };
        // ==========================================

        // åˆæœŸåŒ–
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        let videoList = [];
        let currentPlayingId = "";
        const votedVideoIds = new Set();
        const savedVotes = localStorage.getItem('votedVideos');
        if (savedVotes) JSON.parse(savedVotes).forEach(id => votedVideoIds.add(id));

        // ãƒ™ã‚¤ã‚¸ã‚¢ãƒ³å¹³å‡
        const M = 5; const C = 3.0;
        function getBayesianScore(video) {
            const rawScore = video.score;
            const votes = video.votes;
            return ( (rawScore * votes) + (C * M) ) / (votes + M);
        }

        // === ğŸš€ èµ·å‹• & ãƒ‡ãƒ¼ã‚¿ç›£è¦– ===
        window.onload = function() {
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                splash.classList.add('fade-out');
                setTimeout(() => { splash.style.display = 'none'; }, 600);
            }, 2000);

            const videosRef = db.ref('videos');
            
            videosRef.on('value', (snapshot) => {
                const data = snapshot.val();
                videoList = [];
                if (data) {
                    Object.keys(data).forEach(key => videoList.push(data[key]));
                }

                renderRanking();
                
                // åˆå›èª­ã¿è¾¼ã¿ or ç¾åœ¨ã®å‹•ç”»æ›´æ–°
                if (currentPlayingId) {
                    const currentVideo = videoList.find(v => v.id === currentPlayingId);
                    if (currentVideo) updateScoreDisplay(currentVideo);
                } else if (videoList.length > 0) {
                    // ã‚½ãƒ¼ãƒˆã—ã¦1ä½ã‚’å†ç”Ÿ
                    const sorted = [...videoList].sort((a, b) => getBayesianScore(b) - getBayesianScore(a));
                    const top = sorted[0];
                    if (top) playVideo(top.id, top.title, top.isVertical, top.service || "youtube");
                }
            });
        };

        // === ç”»é¢é·ç§» ===
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            const nav = document.getElementById('nav-' + pageId);
            if(nav) nav.classList.add('active');
        }

        // === ğŸ¥ å‹•ç”»å†ç”Ÿ (YouTube & TikTokå¯¾å¿œ) ===
        function playVideo(videoId, title, isVertical = false, service = "youtube") {
            showPage('home');
            const player = document.getElementById('main-player');
            const container = document.getElementById('player-container');
            const tagLabel = document.getElementById('player-tag');
            
            currentPlayingId = videoId;
            document.getElementById('video-title').innerText = title;

            // ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ
            if (service === "tiktok") {
                player.src = `https://www.tiktok.com/embed/v2/${videoId}`;
                tagLabel.innerText = "TikTok";
                tagLabel.className = "bg-black text-white text-[10px] px-2 py-0.5 rounded-full font-bold";
            } else {
                player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&rel=0`;
                tagLabel.innerText = "YouTube";
                tagLabel.className = "bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold";
            }

            // ç¸¦æ¨ªã®ã‚µã‚¤ã‚ºèª¿æ•´
            if(isVertical) {
                container.classList.remove('aspect-video');
                container.classList.add('aspect-[9/16]');
            } else {
                container.classList.add('aspect-video');
                container.classList.remove('aspect-[9/16]');
            }

            const targetVideo = videoList.find(v => v.id === videoId);
            updateScoreDisplay(targetVideo);
        }

        function updateScoreDisplay(video) {
            if(!video) return;
            const bayesian = getBayesianScore(video);
            document.getElementById('display-score').innerText = "â™ª" + bayesian.toFixed(2);
            document.getElementById('display-votes').innerText = video.votes.toLocaleString() + " è©•ä¾¡";
            
            if (votedVideoIds.has(video.id)) lockRatingUI();
            else resetRatingUI();
        }

        // === è©•ä¾¡UI ===
        const notePath = '<path stroke="none" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>';
        document.querySelectorAll('.note-icon').forEach(n => n.innerHTML = notePath);
        const labels = ["ã†ãƒ¼ã‚“... ã„ã¾ã„ã¡ ğŸ¤”", "ã¾ã‚ã¾ã‚ã‹ãª ğŸ™‚", "ãµã¤ã†ã«è‰¯ã„ï¼ ğŸ‘", "ã“ã‚Œã¯ãŠã™ã™ã‚ï¼ âœ¨", "ç¥å‹•ç”»ã‚­ã‚¿ã‚³ãƒ¬ï¼ï¼ ğŸ‘‘"];
        let currentUserScore = 0;

        function rateHome(score) {
            if (votedVideoIds.has(currentPlayingId)) return;
            currentUserScore = score;
            const icons = document.querySelectorAll('#page-home .note-icon');
            icons.forEach((icon, index) => {
                if (index < score) icon.classList.add('active');
                else icon.classList.remove('active');
            });
            document.getElementById('home-rating-label').innerHTML = `<span class="text-pink-500 font-bold text-sm bounce-in">${labels[score - 1]}</span>`;
            const btn = document.getElementById('home-submit-btn');
            btn.disabled = false;
            btn.className = "w-full bg-pink-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-pink-200 hover:bg-pink-600 active:scale-95 bouncy-btn";
            btn.innerText = "è©•ä¾¡ã‚’é€ã‚‹ âœ¨";
        }

        function resetRatingUI() {
            currentUserScore = 0;
            const icons = document.querySelectorAll('#page-home .note-icon');
            icons.forEach(icon => icon.classList.remove('active'));
            document.getElementById('home-rating-label').innerHTML = `<span class="text-gray-300 text-xs font-bold">ã‚¿ãƒƒãƒ—ã—ã¦è©•ä¾¡</span>`;
            const btn = document.getElementById('home-submit-btn');
            btn.disabled = true;
            btn.className = "w-full bg-gray-100 text-gray-400 font-bold py-3 rounded-xl transition-all shadow-none bouncy-btn";
            btn.innerText = "è©•ä¾¡ã‚’é€ã‚‹ âœ¨";
        }

        function lockRatingUI() {
            currentUserScore = 0;
            const icons = document.querySelectorAll('#page-home .note-icon');
            icons.forEach(icon => icon.classList.remove('active'));
            document.getElementById('home-rating-label').innerHTML = `<span class="text-pink-500 text-xs font-bold">æŠ•ç¥¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</span>`;
            const btn = document.getElementById('home-submit-btn');
            btn.disabled = true;
            btn.innerText = "è©•ä¾¡æ¸ˆã¿ âœ…";
            btn.className = "w-full bg-gray-300 text-white font-bold py-3 rounded-xl shadow-none cursor-not-allowed";
        }

        // === ğŸ”¥ è©•ä¾¡é€ä¿¡ ===
        function submitRating() {
            if (votedVideoIds.has(currentPlayingId)) return;
            if(currentUserScore > 0 && currentPlayingId) {
                const videoRef = db.ref('videos/' + currentPlayingId);
                videoRef.transaction((video) => {
                    if (video) {
                        const oldTotal = video.score * video.votes;
                        video.votes++;
                        video.score = (oldTotal + currentUserScore) / video.votes;
                    }
                    return video;
                }, (error, committed) => {
                    if (error) alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    else if (committed) {
                        votedVideoIds.add(currentPlayingId);
                        localStorage.setItem('votedVideos', JSON.stringify([...votedVideoIds]));
                        alert(`è©•ä¾¡ã—ã¾ã—ãŸï¼\nãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«åæ˜ ã•ã‚Œã¾ã™âœ¨`);
                        lockRatingUI();
                    }
                });
            }
        }

        // === ğŸ”¥ æŠ•ç¨¿æ©Ÿèƒ½ (YouTube Shorts & TikTok å¯¾å¿œç‰ˆ) ===
        function submitPost() {
            const url = document.getElementById('url-input').value;
            
            // â˜…ã“ã“ä¿®æ­£: |shorts\/ ã‚’è¿½åŠ ã—ã¦ã‚·ãƒ§ãƒ¼ãƒˆå‹•ç”»ã‚‚èªè­˜ã•ã›ã‚‹ï¼
            const ytRegExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/;
            const ttRegExp = /tiktok\.com\/@.+\/video\/(\d+)/;

            let videoId = "";
            let service = "";
            // â˜…ã‚·ãƒ§ãƒ¼ãƒˆã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ãƒ•ãƒ©ã‚°
            let isShorts = false;

            const ytMatch = url.match(ytRegExp);
            const ttMatch = url.match(ttRegExp);

            if (ytMatch && ytMatch[2].length === 11) {
                videoId = ytMatch[2];
                service = "youtube";
                // URLã« "shorts" ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ç¸¦é•·èªå®šã™ã‚‹
                if (url.includes("shorts")) {
                    isShorts = true;
                }
            } else if (ttMatch) {
                videoId = ttMatch[1];
                service = "tiktok";
            } else {
                alert("YouTube ã¾ãŸã¯ TikTok ã®URLã‚’å…¥ã‚Œã¦ã­ğŸ’¦");
                return;
            }

            // APIã®æŒ¯ã‚Šåˆ†ã‘
            let apiUrl = "";
            if (service === "youtube") {
                apiUrl = `https://noembed.com/embed?url=${encodeURIComponent(url)}`;
            } else {
                apiUrl = `https://www.tikwm.com/api/?url=${encodeURIComponent(url)}`;
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    let realTitle = "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜";
                    let thumbnail = "";

                    if (service === "youtube") {
                        realTitle = data.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜";
                        thumbnail = data.thumbnail_url || "";
                    } else {
                        if (data.data) {
                            realTitle = data.data.title || "TikTokå‹•ç”»";
                            thumbnail = data.data.cover || "";
                        }
                    }

                    const newVideo = {
                        id: videoId,
                        service: service, 
                        title: realTitle,
                        thumbnail: thumbnail, 
                        tag: service === "tiktok" ? "TikTok" : (isShorts ? "Shorts" : "æ–°ç€"), // ã‚¿ã‚°ã‚‚å¤‰ãˆã‚‹
                        score: 5,
                        votes: 1,
                        // â˜…TikTok ã¾ãŸã¯ YouTubeã‚·ãƒ§ãƒ¼ãƒˆ ãªã‚‰ç¸¦é•·(true)ã«ã™ã‚‹
                        isVertical: (service === "tiktok" || isShorts) ? true : false 
                    };
                    
                    return db.ref('videos/' + videoId).set(newVideo);
                })
                .then(() => {
                    alert(`æŠ•ç¨¿ã—ã¾ã—ãŸï¼\nãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«è¿½åŠ ã•ã‚Œã¾ã™âœ¨`);
                    document.getElementById('url-input').value = "";
                    showPage('rank');
                })
                .catch((error) => {
                    alert("å–å¾—ã‚¨ãƒ©ãƒ¼: " + error.message);
                });
        }

        // === ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º (YouTubeã®ã¿) ===
        function checkUrl() {
            const input = document.getElementById('url-input').value;
            const placeholder = document.getElementById('preview-placeholder');
            const frame = document.getElementById('preview-frame');
            
            // YouTubeã®å ´åˆã®ã¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            const ytRegExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = input.match(ytRegExp);

            if (match && match[2].length === 11) {
                placeholder.classList.add('hidden');
                frame.classList.remove('hidden');
                frame.src = `https://www.youtube.com/embed/${match[2]}`;
            } else {
                // TikTokãªã©ã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼éš ã™
                placeholder.classList.remove('hidden');
                frame.classList.add('hidden');
            }
        }

        // === ğŸ‘‘ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”Ÿæˆ (Shortsã‚¿ã‚°è¡¨ç¤ºå¯¾å¿œ) ===
        function renderRanking() {
            const container = document.getElementById('ranking-container');
            if (!container) return;

            const sortedList = [...videoList].sort((a, b) => getBayesianScore(b) - getBayesianScore(a));

            let html = "";
            sortedList.forEach((video, index) => {
                const rank = index + 1;
                const bayesianScore = getBayesianScore(video).toFixed(2);
                const delayStyle = `animation-delay: ${0.1 * (index > 10 ? 10 : index)}s`;
                const votedMark = votedVideoIds.has(video.id) ? '<span class="absolute top-2 right-2 text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded-full font-bold z-20">è©•ä¾¡æ¸ˆ</span>' : '';
                
                const service = video.service || "youtube";
                
                // ã‚µãƒ ãƒã‚¤ãƒ«å‡¦ç†
                let thumbUrl = video.thumbnail;
                let currentService = service;
                if (/^\d+$/.test(video.id)) {
                    currentService = "tiktok";
                }
                if (!thumbUrl) {
                    if (currentService === "tiktok") {
                        thumbUrl = "https://cdn-icons-png.flaticon.com/512/3046/3046121.png";
                    } else {
                        thumbUrl = `https://i.ytimg.com/vi/${video.id}/hqdefault.jpg`;
                    }
                }

                // â˜…ã“ã“ã‚’ä¿®æ­£ï¼ (ä¿å­˜ã•ã‚ŒãŸã‚¿ã‚°æƒ…å ±ã‚’å„ªå…ˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ)
                let tagName = video.tag || "YouTube"; // ä¿å­˜ã•ã‚ŒãŸã‚¿ã‚°ã‚’ä½¿ã†ï¼
                let tagColor = "bg-red-500";

                if (currentService === "tiktok" || tagName === "TikTok") {
                    tagName = "TikTok";
                    tagColor = "bg-black";
                } else if (video.isVertical || tagName === "Shorts") {
                    // ç¸¦é•·ã€ã¾ãŸã¯ã‚¿ã‚°ãŒShortsãªã‚‰
                    tagName = "Shorts";
                    tagColor = "bg-red-600";
                }

                // --- ã“ã“ã‹ã‚‰ä¸‹ã¯è¡¨ç¤ºç”¨ã®HTML ---
                if (rank === 1) {
                    html += `
                    <div onclick="playVideo('${video.id}', '${video.title}', ${video.isVertical}, '${service}')" class="stagger-item bg-white p-4 rounded-3xl shadow-md border-2 border-yellow-200 relative overflow-hidden cursor-pointer active:scale-95 transition-transform" style="${delayStyle}">
                        ${votedMark}
                        <div class="absolute -right-4 -top-4 bg-yellow-300 w-16 h-16 rounded-full opacity-20"></div>
                        <div class="absolute top-0 left-0 bg-yellow-400 text-white font-black px-3 py-1 rounded-br-2xl text-sm z-10">1ä½</div>
                        <div class="flex items-start gap-4 mt-2">
                            <div class="w-20 h-28 bg-gray-800 rounded-xl overflow-hidden relative shadow-md flex-shrink-0">
                                <img src="${thumbUrl}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentNode.style.backgroundColor='#000';">
                                <div class="absolute inset-0 flex items-center justify-center text-white text-2xl">â–¶</div>
                            </div>
                            <div class="flex-1 py-1">
                                <h3 class="font-bold text-gray-800 text-lg mb-1 leading-tight line-clamp-2">${video.title}</h3>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="${tagColor} text-white text-[10px] px-2 py-0.5 rounded-full font-bold">${tagName}</span>
                                </div>
                                <div class="flex items-baseline gap-1">
                                    <span class="text-pink-500 font-black text-2xl">â™ª${bayesianScore}</span>
                                    <span class="text-[10px] text-gray-400">${video.votes.toLocaleString()} è©•ä¾¡</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
                } else {
                    html += `
                    <div onclick="playVideo('${video.id}', '${video.title}', ${video.isVertical}, '${service}')" class="stagger-item bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 bouncy-btn cursor-pointer" style="${delayStyle}">
                        ${votedMark}
                        <div class="text-2xl font-bold text-gray-400 w-6 text-center">${rank}</div>
                        <div class="w-16 h-12 bg-gray-200 rounded-lg overflow-hidden relative flex-shrink-0">
                             <img src="${thumbUrl}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentNode.style.backgroundColor='#000';">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-gray-700 text-sm truncate">${video.title}</h3>
                             <div class="flex items-center gap-2">
                                <span class="${tagColor} text-white text-[8px] px-1.5 py-0.5 rounded font-bold">${tagName}</span>
                                <span class="text-pink-400 font-bold text-sm">â™ª${bayesianScore}</span>
                            </div>
                        </div>
                    </div>`;
                }
            });
            container.innerHTML = html;
        }
    </script>
</body>
</html>
